<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Step Form</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
  
  <style>
    /* ===== RESET & BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }

    body {
      padding-top: 10px; /* Space for fixed progress bar */
      background-color: #f5f5f5;
    }

    /* ===== PROGRESS BAR ===== */
    .msf-topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: #eef2f6;
      z-index: 9999;
    }

    .msf-topbar__fill {
      height: 100%;
      width: 0%;
      background: #fe6337;
      transition: width 0.25s ease;
    }

    /* ===== FORM LAYOUT ===== */
    .form-wrapper {
      padding: 40px;
      position: relative;
      max-width: 800px;
      background-color: #ffffff;
      margin: 0 auto;
      border-radius: 24px;
      margin-top: 40px;
    }

    .msf-step {
      display: none;
    }

    .msf-step.is-active {
      display: block;
    }

    /* ===== HEADER ===== */
    .msf-header {
      position: relative;
      display: flex;
      align-items: center;
      min-height: 44px;
      margin: 0 0 12px;
    }

    .msf-header .msf-btn.back {
      position: absolute;
      left: 0;
      top: 0;
    }

    .msf-header__logo {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      opacity: 0.9;
    }

    /* ===== NAVIGATION ===== */
    .msf-nav {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      align-items: center;
      padding: 16px 0 8px 0;
    }

    /* ===== BUTTONS ===== */
    .msf-btn {
      appearance: none;
      border: 1px solid #d0d7de;
      background: #fff;
      color: #24292f;
      border-radius: 10px;
      padding: 10px 14px;
      font: 600 14px/1 system-ui;
      cursor: pointer;
      transition: transform 0.02s ease;
    }

    .msf-btn:active {
      transform: translateY(1px);
    }

    .msf-btn[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .msf-btn.primary {
      background: #fe6337;
      color: #fff;
      border-color: #fe6337;
      display: block;
      width: 100%;
      height: 40px;
    }

    .msf-btn.primary[disabled] {
      background: #a8a8a8;
      border-color: #a8a8a8;
      color: #fff;
    }

    .msf-btn.back {
      background: #fff;
    }

    .msf-btn.back::before {
      content: '←';
      margin-right: 6px;
    }

    .msf-btn.back[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== TYPOGRAPHY ===== */
    h1 {
      text-align: center;
      font-size: 20px;
      color: #313131;
      margin-top: 40px;
      font-weight: 600;
      margin-bottom: 32px;
    }

    h2 {
      font-size: 20px;
      font-style: normal;
      font-weight: 600;
      color: #13828A;
      text-align: center;
      padding: 24px 0 12px 0;
    }

    p {
      text-align: center;
      font-size: 14px;
      color: #808080;
    }

    /* ===== FORM ELEMENTS ===== */
    fieldset {
      max-width: inherit !important;
    }

    fieldset.form-columns-1 {
      margin: 32px 0 !important;
    }

    fieldset.form-columns-2,
    fieldset.form-columns-3 {
      display: flex;
      gap: 32px;
      margin-bottom: 32px !important;
    }

    label {
      padding-bottom: 8px;
      font-size: 14px;
    }

    input {
      width: 100%;
      max-width: inherit !important;
      border-radius: 8px;
      border: 1px solid #ccc;
      height: 40px;
      margin-top: 8px !important;
    }

    input[type="radio" i] {
      height: auto !important;
      width: inherit !important;
    }

    select {
      height: 40px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .hs-input {
      width: 100% !important;
      padding-left: 16px;
      font-size: 14px;
      font-weight: 400;
    }

    /* ===== VALIDATION & ERRORS ===== */
    span.hs-form-required {
      color: red !important;
    }

    label.hs-error-msg.hs-main-font-element {
      color: red;
      font-size: 12px;
      padding-top: 6px;
      position: absolute;
    }

    li {
      list-style-type: none;
    }

    li.hs-error-msg {
      list-style-type: none !important;
    }

    /* ===== SUBMIT BUTTON ===== */
    .msf-submit.actions {
      display: flex;
      justify-content: flex-end;
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 1024px) {
      fieldset.form-columns-2,
      fieldset.form-columns-3 {
        flex-direction: column;
      }

      .hs-form-field {
        width: 100% !important;
      }
    }
  </style>
</head>

<body>
  <div class="form-wrapper">
    <!-- Header with Back button and Logo -->
    <div class="msf-header">
      <button type="button" class="msf-btn back" id="globalBackBtn">Back</button>
      <img class="msf-header__logo" alt="Logo" width="240" src="logo-jem.png" />
    </div>

    <h2>Professional Services Request</h2>
    <p>We strive to deliver the best service for our customers. In order to do that, we need a little bit more information about the project to best serve you. </p>

    <!-- HubSpot Form -->
    <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/embed/v2.js"></script>
    <script>
      hbspt.forms.create({
        portalId: "20661566",
        formId: "b1918b8e-61ec-4407-94bd-8c949ebc59a4",
        region: "na1"
      });
    </script>
  </div>

  <!-- Multi-Step Form Logic -->
  <script>
    (() => {
      const FORM_SELECTOR = '#hsForm_b1918b8e-61ec-4407-94bd-8c949ebc59a4';

      const isVisible = el => !!(el.offsetParent || el.getClientRects().length);
      const qsa = (root, sel) => Array.from(root.querySelectorAll(sel));

      function isHsFieldWrapperValid(wrapper) {
        const required = !!wrapper.querySelector('.hs-form-required');
        const controls = qsa(wrapper, 'input, select, textarea');

        for (const c of controls) {
          if (!isVisible(c) || c.type === 'hidden' || c.disabled) continue;
          if (c.willValidate && !c.checkValidity()) return false;
        }

        if (!required) return true;

        const radios = qsa(wrapper, 'input[type="radio"]');
        if (radios.length) return radios.some(r => r.checked);

        const checkboxes = qsa(wrapper, 'input[type="checkbox"]');
        if (checkboxes.length) return checkboxes.some(c => c.checked);

        const fileInputs = qsa(wrapper, 'input[type="file"]');
        if (fileInputs.length) return fileInputs.every(f => f.files && f.files.length > 0);

        const selects = qsa(wrapper, 'select');
        if (selects.length) return selects.every(s => (s.value || '').trim() !== '');

        const textInputs = controls.filter(c => ['INPUT', 'TEXTAREA'].includes(c.tagName));
        if (textInputs.length) return textInputs.every(c => (c.value || '').trim() !== '');

        return true;
      }

      function isStepValid(step) {
        const wrappers = qsa(step, '.hs-form-field');
        for (const w of wrappers) {
          if (!isHsFieldWrapperValid(w)) return false;
        }
        return true;
      }

      function firstInvalidInStep(step) {
        const wrappers = qsa(step, '.hs-form-field');
        for (const w of wrappers) {
          if (!isHsFieldWrapperValid(w)) {
            return w.querySelector('input, select, textarea');
          }
        }
        return null;
      }

      function validateTakeOffSectionFields() {
        const section = document.querySelector('.msf-step[data-title="Take-off Information"]');
        if (!section || !isVisible(section)) return true;

        let isValid = true;

        const requiredFields = [
          {
            selector: 'input[name="scope"]',
            type: 'radio'
          },
          {
            selector: 'input[name="what_is_the_due_date_for_submission_"]',
            type: 'input'
          },
          {
            selector: 'input[name="take_off_price"]',
            type: 'input'
          },
          {
            selector: 'input[name="po_number"]',
            type: 'input'
          }
        ];

        requiredFields.forEach(field => {
          const inputs = Array.from(section.querySelectorAll(field.selector));

          if (field.type === 'radio') {
            const checked = inputs.some(i => i.checked);
            const wrapper = inputs[0]?.closest('.hs-form-field');
            if (!checked) {
              isValid = false;
              wrapper?.classList.add('field-error');
            } else {
              wrapper?.classList.remove('field-error');
            }
          } else {
            const input = inputs[0];
            const wrapper = input?.closest('.hs-form-field');
            if (!input || input.value.trim() === '') {
              isValid = false;
              wrapper?.classList.add('field-error');
            } else {
              wrapper?.classList.remove('field-error');
            }
          }
        });

        return isValid;
      }

      function buildSteps(form) {
        const steps = [];
        const kids = Array.from(form.children);
        let currentStep = null;

        for (const node of kids) {
          const isH1Fieldset = node.matches('fieldset') && node.querySelector('.hs-richtext h1');
          if (isH1Fieldset) {
            currentStep = document.createElement('section');
            currentStep.className = 'msf-step';
            const title = node.querySelector('h1')?.textContent?.trim() || 'Step';
            currentStep.dataset.title = title;
            form.insertBefore(currentStep, node);
            steps.push(currentStep);
          }
          if (currentStep) currentStep.appendChild(node);
        }

        const submit = form.querySelector('.hs_submit.actions');
        if (submit && steps.length) {
          submit.classList.add('msf-submit', 'actions');
          steps[steps.length - 1].appendChild(submit);
        }

        return steps;
      }

      function addNavUI(form, steps) {
        let topbar = document.getElementById('msf-topbar');
        if (!topbar) {
          topbar = document.createElement('div');
          topbar.id = 'msf-topbar';
          topbar.className = 'msf-topbar';
          const fill = document.createElement('div');
          fill.className = 'msf-topbar__fill';
          topbar.appendChild(fill);
          document.body.prepend(topbar);
        }

        steps.forEach((step, idx) => {
          const nav = document.createElement('div');
          nav.className = 'msf-nav';

          const next = document.createElement('button');
          next.type = 'button';
          next.className = 'msf-btn primary';
          next.textContent = 'Next Section';

          if (idx === steps.length - 1) next.style.display = 'none';

          nav.append(next);
          step.appendChild(nav);

          next.addEventListener('click', () => {
            const currentTitle = step.dataset.title;

            if (!isStepValid(step)) {
              const bad = firstInvalidInStep(step);
              if (bad?.reportValidity) bad.reportValidity();
              bad?.focus();
              return;
            }

            if (currentTitle === 'Take-off Information' && !validateTakeOffSectionFields()) {
              return;
            }

            if (currentTitle === 'Plans and Additional Information') {
              const select = document.querySelector('#type_of_services_required_-b1918b8e-61ec-4407-94bd-8c949ebc59a4');
              const selectedValue = select?.value?.trim();

              if (selectedValue === 'Project Design') {
                const designStepIndex = steps.findIndex(s => s.dataset.title === 'Project Design Information');
                if (designStepIndex !== -1) {
                  goTo(designStepIndex);
                  return;
                }
              } else {
                const takeoffStepIndex = steps.findIndex(s => s.dataset.title === 'Take-off Information');
                if (takeoffStepIndex !== -1) {
                  goTo(takeoffStepIndex);
                  return;
                }
              }
            }

            goTo(idx + 1);
          });

          const updateNextState = () => {
            let valid = isStepValid(step);
            if (step.dataset.title === 'Take-off Information') {
              valid = valid && validateTakeOffSectionFields();
            }
            next.disabled = !valid;
          };

          qsa(step, 'input, select, textarea').forEach(ctrl => {
            ['input', 'change', 'blur'].forEach(ev => ctrl.addEventListener(ev, updateNextState));
          });

          step.__updateNextState = updateNextState;

          if (idx === steps.length - 1) {
            qsa(form, '.hs_submit.actions').forEach(el => el.style.display = '');
          }
        });

        function renderProgress(activeIndex) {
          const topbar = document.getElementById('msf-topbar');
          if (topbar) {
            const fill = topbar.querySelector('.msf-topbar__fill');
            const total = steps.length;
            const pct = total > 1 ? (activeIndex / (total - 1)) * 100 : 100;
            fill.style.width = `${pct}%`;
          }
        }

        return { renderProgress };
      }

      function init(form) {
        if (form.__msfInit) return;
        form.__msfInit = true;

        const steps = buildSteps(form);
        if (!steps.length) return;

        const { renderProgress } = addNavUI(form, steps);

        let current = 0;

        function show(i) {
          steps.forEach((s, idx) => s.classList.toggle('is-active', idx === i));

          const submit = form.querySelector('.hs_submit.actions');
          if (submit) submit.style.display = i === steps.length - 1 ? '' : 'none';

          steps[i].__updateNextState?.();

          const backBtn = document.getElementById('globalBackBtn');
          if (backBtn) backBtn.disabled = i === 0;

          const bad = firstInvalidInStep(steps[i]);
          const candidate = bad || steps[i].querySelector('input, select, textarea, button');
          candidate?.focus({ preventScroll: true });

          renderProgress(i);
          current = i;
        }

        window.goTo = (i) => {
          if (i < 0 || i >= steps.length) return;
          show(i);
        };

        form.addEventListener('submit', (e) => {
          if (current < steps.length - 1) e.preventDefault();
        });

        show(0);

        const backBtn = document.getElementById('globalBackBtn');
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            const currentStep = steps[current];
            const currentTitle = currentStep.dataset.title;
            const select = document.querySelector('#type_of_services_required_-b1918b8e-61ec-4407-94bd-8c949ebc59a4');
            const selectedValue = select?.value?.trim();

            if (
              currentTitle === 'Project Design Information' &&
              selectedValue === 'Project Design'
            ) {
              const plansStepIndex = steps.findIndex(s => s.dataset.title === 'Plans and Additional Information');
              if (plansStepIndex !== -1) {
                show(plansStepIndex);
                return;
              }
            }

            if (current > 0) show(current - 1);
          });
        }
      }

      const tryInit = () => {
        const f = document.querySelector(FORM_SELECTOR);
        if (f) init(f);
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', tryInit);
      } else {
        tryInit();
      }

      const mo = new MutationObserver(tryInit);
      mo.observe(document.documentElement, { childList: true, subtree: true });
    })();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function waitForElement() {
        const targetElement = document.querySelector('[data-title="Project Design Information"]');
        if (targetElement) {
          init();
        } else {
          setTimeout(waitForElement, 100);
        }
      }

      function init() {
        const communicatorFieldYes = document.querySelector('input[name="are_you_adding_a_communicator_to_the_project_"][value="Yes"]');
        const communicatorFieldNo = document.querySelector('input[name="are_you_adding_a_communicator_to_the_project_"][value="No"]');
        
        const communicatorBrandDiv = document.querySelector('.hs_what_is_the_communicator_brand_and_models_');
        const monitoringCompanyDiv = document.querySelector('.hs_what_is_the_monitoring_company_being_used_');
        const monitoringCertificateDiv = document.querySelector('.hs_upload_the_monitoring_company_ul_certificate');

        if (!communicatorFieldYes || !communicatorFieldNo || !communicatorBrandDiv || !monitoringCompanyDiv || !monitoringCertificateDiv) {
          console.error('Alguns elementos não foram encontrados.');
          return;
        }

        function toggleFields() {
          const isCommunicatorYes = communicatorFieldYes.checked;
          
          communicatorBrandDiv.style.display = isCommunicatorYes ? 'block' : 'none';
          monitoringCompanyDiv.style.display = isCommunicatorYes ? 'block' : 'none';
          monitoringCertificateDiv.style.display = isCommunicatorYes ? 'block' : 'none';
        }

        communicatorFieldYes.addEventListener('change', toggleFields);
        communicatorFieldNo.addEventListener('change', toggleFields);

        toggleFields();
      }

      waitForElement();
    });
  </script>

  <script>
    if ('WebSocket' in window) {
      (function () {
        function refreshCSS() {
          var sheets = [].slice.call(document.getElementsByTagName("link"));
          var head = document.getElementsByTagName("head")[0];
          for (var i = 0; i < sheets.length; ++i) {
            var elem = sheets[i];
            var parent = elem.parentElement || head;
            parent.removeChild(elem);
            var rel = elem.rel;
            if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
              var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
              elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
            }
            parent.appendChild(elem);
          }
        }
        var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
        var address = protocol + window.location.host + window.location.pathname + '/ws';
        var socket = new WebSocket(address);
        socket.onmessage = function (msg) {
          if (msg.data == 'reload') window.location.reload();
          else if (msg.data == 'refreshcss') refreshCSS();
        };
        if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
          console.log('Live reload enabled.');
          sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
        }
      })();
    } else {
      console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
    }
  </script>
</body>
</html>


